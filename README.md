# Node.Js

é¦–æ¬¡å¼€ä»“äºŽ--------2023.06.12

ç¬¬0ç«  Promise åœ¨JSæ¿å— å®Œç»“

---

## ç¬¬1ç«  æ¦‚è¿°

nodeJsï¼šæ˜¯JavaScriptè¿è¡Œæ—¶çš„å¼•æ“Ž

ä¸ºä»€ä¹ˆé€‚åˆåŽç«¯ç¼–ç¨‹ï¼Ÿ

- å•çº¿ç¨‹ï¼ŒåŸºäºŽäº‹ä»¶é©±åŠ¨ï¼Œéžé˜»å¡žåž‹çš„IOæ¨¡åž‹

- é€‚åˆæž„å»ºè¶…å¿«é€Ÿã€å¯æ‰©å±•çš„æ•°æ®å¯†é›†åž‹åº”ç”¨ç¨‹åº

- å‰åŽç«¯ä»£ç ç»Ÿä¸€

- å…è´¹èµ„æºåº“

- å¤§åž‹æ´»åŠ¨ç¤¾åŒº

æç¤ºï¼šNodeJSä¸ä½¿ç”¨åœ¨å¤šçº¿ç¨‹ã€ç¹é‡æœåŠ¡å™¨ç«¯çš„åº”ç”¨ç¨‹åºä¸Š

#### 1.1 æ–‡ä»¶æ“ä½œ

é¦–å…ˆé€šè¿‡`require('fs)`èŽ·å–æ–‡ä»¶æ¨¡å—

| åç§°   | è¯´æ˜Ž                                                                   | è¡¥å……                     |
| ---- | -------------------------------------------------------------------- | ---------------------- |
| è¯»å–æ–‡ä»¶ | `fs.readFileSync('./txt/input.txt','utf-8')`                         | ç¤ºä¾‹ä¸­çš„å‚æ•°ï¼Œåœ°å€å’Œç¼–ç æ–¹å¼         |
| å†™å…¥æ–‡ä»¶ | `fs.writeFileSync('./txt/output.txt',textOut);`                      | ç¤ºä¾‹ä¸­çš„å‚æ•°ï¼Œåœ°å€å’Œå†…å®¹           |
| å¼‚æ­¥è¯»å– | `fs.readFile('./txt/start.txt', 'utf-8', (err, data1) => {}`         | å‚æ•°ï¼Œæ–‡ä»¶åœ°å€ã€ç¼–ç æ ¼å¼ã€å›žè°ƒå‡½æ•°      |
| å¼‚æ­¥å†™å…¥ | `fs.writeFile('./txt/final.txt','abcde','utf-8', (err, data4) => {}` | å‚æ•°ï¼Œæ–‡ä»¶åœ°å€ã€å†™å…¥å†…å®¹ã€ç¼–ç æ ¼å¼ã€å›žè°ƒå‡½æ•° |

#### 1.2 åˆ›å»ºã€ç›‘å¬æœåŠ¡å™¨

é¦–å…ˆå¼•å…¥`const http = require('http')`æ¨¡å—

1. åˆ›å»ºæœåŠ¡å™¨

```js
const server = http.createServer((req,res)=>{
    res.end('Hello from the server!')
})
```

2. ç›‘å¬æœåŠ¡å™¨

è¯´æ˜Žï¼Œè®¾ç½®ç«¯å£å·ã€åœ°å€ã€å›žè°ƒå‡½æ•°ï¼ˆå½“è¢«è®¿é—®æ—¶è§¦å‘ï¼‰

```js
server.listen(8001,'127.0.0.1',()=>{
    console.log('Listening to requests on port 8001')
})
```

#### 1.3 ä½¿ç”¨æœåŠ¡å™¨ã€è®¾ç½®è·¯ç”±

æŒ‡ä»¤å¯åŠ¨æœåŠ¡å™¨ï¼Œå¦‚æžœå¯¹æ–‡ä»¶è¿›è¡Œæ›´æ”¹ï¼Œè¦è®°å¾—é‡å¯æœåŠ¡å™¨

`node index.js`

è®¾ç½®è·¯ç”±

- èŽ·å–è¯·æ±‚è·¯ç”±ï¼Œ`req.url`

- è®¾ç½®å“åº”å¤´ï¼Œ`res.writeHead(çŠ¶æ€ç ,{å“åº”å¤´})`

ç¤ºä¾‹ï¼š

```js
res.writeHead(404,{
            'Content-type':'text/html',
            'my-own-header':'hello-world'
        })
```

#### 1.4 æ€»ç»“

è¿‡åŽ»å®‰è£…ä¾èµ–çš„å‘½ä»¤

`npm install slugify --save`

çŽ°åœ¨å¯ä»¥çœç•¥æŽ‰

`--save`

å…¨å±€å®‰è£…

`--global`

ðŸ˜‰ç›‘å¬æ”¹å˜ï¼Œè‡ªåŠ¨é‡å¯nodeæœåŠ¡å™¨

`npm install nodemon --save-dev`

**npmæŒ‡ä»¤**

| æŒ‡ä»¤              | è§£é‡Š       | å¤‡æ³¨  |
| --------------- | -------- | --- |
| `npm updated`   | æ£€æŸ¥ä¾èµ–æ˜¯å¦è¿‡æœŸ |     |
| `npm uninstall` |          |     |
| `npm update`    | æ›´æ–°ä¾èµ–     |     |

**ç‰ˆæœ¬å·è¯´æ˜Ž**

è¡¨çŽ°å½¢å¼ï¼š`xx.yy.zz`

- `zz`ï¼šå‘ç”Ÿæ›´æ–°ï¼Œä¿®å¤åŒ…ä¸­çš„é”™è¯¯

- `yy`ï¼šå‘ç”Ÿæ›´æ–°ï¼Œå‘å¸ƒæ–°åŠŸèƒ½ï¼Œå‘åŽå…¼å®¹

- `xx`ï¼šå‘ç”Ÿæ›´æ–°ï¼Œæ¬¡ä»£ç‰ˆæœ¬ä»£ç å¯èƒ½å¤±æ•ˆ

---

## ç¬¬äºŒç«  Webæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ

#### 2.1 è¯·æ±‚å“åº”æ¨¡åž‹

è¯·æ±‚ç”±ï¼š

1. åè®®ã€åŸŸåã€èµ„æºå

2. åè®®ã€IPåœ°å€ã€ç«¯å£å·(https çš„é»˜è®¤ç«¯å£å·ä¸º443ã€httpçš„é»˜è®¤ç«¯å£å·ä¸º80)

`request`:

- è¯·æ±‚æ–¹å¼ã€è¯·æ±‚ç›®æ ‡ã€HTTPç‰ˆæœ¬

- è¯·æ±‚å¤´

- è¯·æ±‚ä½“

`response`:

- HTTPç‰ˆæœ¬ã€çŠ¶æ€ç ã€çŠ¶æ€æ¶ˆæ¯

- å“åº”å¤´

- å“åº”ä½“

è¯·æ±‚åˆ°å“åº”çš„æ•´ä¸ªè¿‡ç¨‹ï¼š

1. å°†è¯·æ±‚è¿žæŽ¥å‘é€è‡³DNSæœåŠ¡å™¨ï¼ŒèŽ·å–å¯¹åº”çš„IPåœ°å€å’Œç«¯å£å·

2. æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å‘èµ·`TCP/IP`å¥—æŽ¥å­—è¿žæŽ¥

3. å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚

4. æœåŠ¡å™¨è¿”å›žå“åº”

> æç¤ºï¼š
> 
> `http`ä¸Ž`https`ä¹‹é—´çš„åŒºåˆ«æ˜¯ï¼Œ`https`ä½¿ç”¨äº†TLSæˆ–SSLåŠ å¯†
> 
> TCP(é€šè®¯ä¼ è¾“åè®®)ï¼šåˆ†è§£è¯·æ±‚ï¼Œæ‹¿åˆ°æ‰€æœ‰çš„æ•°æ®åŒ…å°å—
> 
> IP(ç½‘ç»œé€šä¿¡åè®®)ï¼šå°†æ•°æ®åŒ…å…¨éƒ¨å‘é€è‡³å®¢æˆ·ç«¯

5. å®¢æˆ·ç«¯è¯»å–æ•°æ® 
   
   - è¯»å–å…¥å£æ–‡ä»¶(`.html`)
   
   - æ‰«æèµ„æºæ–‡ä»¶(`.css,.js`)
   
   - å‘ˆçŽ°é¡µé¢

#### 2.2 å‰ç«¯å¯¹æ¯”åŽç«¯

ä¸¤ç§ç½‘ç«™å½¢å¼ï¼š

1. åŠ¨æ€ç½‘ç«™ï¼Œæ•°æ®åº“æ‹¿åˆ°æ•°æ®ã€ä½¿ç”¨æ¨¡æ¿ã€ç”Ÿæˆç½‘ç«™ã€å‘é€ç»™æµè§ˆå™¨

2. APIï¼Œæ•°æ®åº“æ‹¿åˆ°æ•°æ®ã€ç”Ÿæˆ`JSON`æ ¼å¼ã€å‘é€ç»™æµè§ˆå™¨

> åŠ¨æ€ç½‘ç«™ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯åœ¨æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œä¹Ÿè¢«ç§°ä¸ºSSRï¼ˆæœåŠ¡å™¨æ¸²æŸ“ï¼‰
> 
> APIï¼Œå› ä¸ºèŽ·å–æ•°æ®è¿‡ç¨‹å‘ç”Ÿåœ¨æœåŠ¡å™¨ä¸Šï¼Œè€Œæµè§ˆå™¨æ¸²æŸ“å‘ç”Ÿåœ¨å®¢æˆ·ç«¯ï¼Œå› æ­¤è¢«ç§°ä¸ºCSRï¼ˆå®¢æˆ·ç«¯æ¸²æŸ“ï¼‰

---

## ç¬¬ä¸‰ç«  Node.js

#### 3.1 node.js çš„æž¶æž„

ç»„æˆéƒ¨åˆ†ï¼š`v8å¼•æ“Ž`ã€`libuv`ï¼ˆå…³æ³¨å¼‚æ­¥çš„IOã€äº‹ä»¶å¾ªçŽ¯ã€çº¿ç¨‹æ± ï¼‰ã€`http-parser`ã€`c-ares`ã€`OpenSSL`ã€`zlib`

ä¸»ä½“æ˜¯`v8å¼•æ“Ž`ã€`libuv`

å…¶ä½™çš„ä»‹ç»å¦‚ä¸‹ï¼š

1. `http-parser`ï¼Œç”¨äºŽè§£æž`http`

2. `c-ares`ï¼Œç”¨äºŽDNSè¯·æ±‚çš„ä¸œè¥¿

3. `OpenSSL`ï¼Œä¿å­˜è®°å½•

4. `zlib`ï¼Œç”¨äºŽåŽ‹ç¼©

**node.js çš„è¿è¡Œ**

`Node.js`è¿è¡Œåœ¨å•çº¿ç¨‹çš„çŽ¯å¢ƒä¸­ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š

1. åˆå§‹åŒ–é¡¹ç›®

2. æ‰§è¡Œé¡¶å±‚ä»£ç 

3. èŽ·å–æ¨¡å—

4. æ³¨å†Œäº‹ä»¶å¾ªçŽ¯

5. å¼€å¯äº‹ä»¶å¾ªçŽ¯ï¼ˆæ ¸å¿ƒï¼‰

å¦å¤–ï¼Œå› ä¸ºäº‹ä»¶å¾ªçŽ¯ä»»åŠ¡ç¹é‡ï¼Œ`libuv`ä¼šå¼€å¯çº¿ç¨‹æ± ï¼Œå°†äº‹ä»¶å¾ªçŽ¯çš„å…¶å®ƒä»»åŠ¡åˆ†å‰²ä¸ºæœ€å¤š128ä¸ªçº¿ç¨‹ï¼Œä¸»è¦åˆ†ç±»ä¸ºå››ç§ä»»åŠ¡ï¼šæ–‡ä»¶å·¥ä½œã€åŠ å¯†ä¸Žè§£å¯†ã€åŽ‹ç¼©ã€DNSæŸ¥é˜…ï¼Œä»¥å‡è½»äº‹ä»¶å¾ªçŽ¯çš„åŽ‹åŠ›ï¼Œä½¿å¾—äº‹ä»¶å¾ªçŽ¯ä¸­ä¿ç•™ä¸»è¦ä»»åŠ¡

#### 3.2 Node.jsæ ¸å¿ƒ äº‹ä»¶å¾ªçŽ¯

1. éžé¡¶å±‚ä»£ç éƒ½ä¼šåœ¨äº‹ä»¶å¾ªçŽ¯ä½“ä¸­è¿è¡Œ

2. Node.jså›´ç»•å›žè°ƒå‡½æ•°æž„å»ºçš„

3. äº‹ä»¶é©±åŠ¨ç»“æž„ï¼Œäº‹ä»¶å‘å‡ºã€äº‹ä»¶å¾ªçŽ¯ä½“èŽ·å–äº‹ä»¶ã€å›žè°ƒè¢«åé¦ˆ

4. äº‹ä»¶å¾ªçŽ¯æ˜¯ç²¾å¿ƒå¸ƒç½®çš„

æœåŠ¡å¼€å¯ä¹‹åŽä¼šå¤„äºŽè¿è¡ŒçŠ¶æ€ï¼Œæ¯å½“æŽ¥æ”¶åˆ°æ–°çš„è¯·æ±‚æ—¶ï¼Œå¤„ç†è¯·æ±‚ï¼Œåé¦ˆæ•°æ®ï¼Œå¹¶å†æ¬¡è¿›å…¥ç›‘å¬çŠ¶æ€ï¼Œç›´åˆ°æœåŠ¡ç»“æŸä¸ºæ­¢ã€‚

#### 3.3 Node.js æ‰§è¡Œå®žè·µ

```js
// 2. èŽ·å–æ¨¡å—æ–‡ä»¶
const fs = require("fs");
const crypto = require("crypto")
const start = new Date()

process.env.UV_THREADPOOL_SIZE = 2


// 3. é€ä¸€èŽ·å–äº‹ä»¶
setTimeout(() => console.log("Timer 1 finished"), 0)  //  1
setImmediate(() => console.log("Immediate 1 finished"))  //  2

fs.readFile("./test-file.txt", () => {     // 3
    console.log("I/O finished")
    console.log("-------------")

    setTimeout(() => console.log("Timer 2 finished"), 0)
    setTimeout(() => console.log("Timer 3 finished"), 3000)
    setImmediate(() => console.log("Immediate 2 finished"))

    process.nextTick(() => console.log("Process.nextTick"))

    crypto.pbkdf2('password', 'salt', 100000, 1024, 'sha512', () => {
        console.log(Date.now() - start, "Password encrypted")
    })

    crypto.pbkdf2('password', 'salt', 100000, 1024, 'sha512', () => {
        console.log(Date.now() - start, "Password encrypted")
    })

    crypto.pbkdf2('password', 'salt', 100000, 1024, 'sha512', () => {
        console.log(Date.now() - start, "Password encrypted")
    })

    crypto.pbkdf2('password', 'salt', 100000, 1024, 'sha512', () => {
        console.log(Date.now() - start, "Password encrypted")
    })


})

// 1. æ‰§è¡Œé¡¶å±‚ä»£ç 
console.log("Hello from the top-level code")


```

#### 3.4 å‘ç”Ÿäº‹ä»¶ä¸Žç›‘å¬äº‹ä»¶

è¿è¡Œçš„è¿‡ç¨‹ï¼š

1. äº‹ä»¶å‘å‡º

2. äº‹ä»¶ç›‘å¬

3. è°ƒç”¨å›žè°ƒå‡½æ•°

å…¶ä¸­ï¼Œ*1ã€2*è¢«ç§°ä½œè§‚å¯Ÿè€…æ¨¡å¼

**æœ¬åœ°äº‹ä»¶ç›‘å¬**

```js
const EventEmitter = require("events")

class Sales extends EventEmitter{
    constructor() {
        super();
    }
}

const myEmitter = new Sales()

// 2. ç›‘å¬äº‹ä»¶
// 3. æŒ‰é¡ºåºå¯ç”¨å›žè°ƒå‡½æ•°
myEmitter.on("newSale", () => {
    console.log("There was a new sale!")
})

myEmitter.on("newSale", () => {
    console.log("Costumer name: Liu")
})

myEmitter.on("newSale", (stock) => {
    console.log(`There are now ${stock} items left in stock`)
})


// 1. å‘å‡ºäº‹ä»¶
myEmitter.emit("newSale");
```

**æœåŠ¡å™¨äº‹ä»¶ç›‘å¬**

```js
const http = require("http")


// 1. åˆ›å»ºç›‘å¬è€…
const server = http.createServer()

// 2. åˆ›å»ºæœåŠ¡å™¨ç›‘å¬è€…ï¼Œç›‘å¬æœåŠ¡å™¨è¿›è¡Œçš„äº‹ä»¶
server.on("request",(req,res) => {
    console.log("Request received!")
    res.end("Request received")
})

server.on("request",(req,res) => {
    console.log("Another request ðŸ˜€")
})

server.on("close",() => {
    console.log("Server closed")
})

// 3. åˆ›å»ºæœåŠ¡å™¨ç›‘å¬è€…ï¼Œç›‘å¬è¯·æ±‚åœ°å€
server.listen(8001,'127.0.0.1',()=>{
    console.log("Waiting for requests...")
})
```
